<%- include("../../partials/header") %>

<div class="dashboard-banner" style="background: linear-gradient(135deg, #a855f7 0%, #d946ef 100%); padding: 40px 20px; text-align: center; color: white;">
    <h1 style="font-size: 2rem; font-weight: 800; margin-bottom: 5px;"><%= exam.title %></h1>
    <p style="opacity: 0.9;">Registrations & Submissions</p>
    <div style="margin-top: 15px;">
        <a href="/exams/admin/dashboard" class="btn btn-secondary-custom" style="padding: 8px 16px; border-radius: 6px; background: rgba(255,255,255,0.2); color: white; text-decoration: none; border: none;">&larr; Back to Dashboard</a>
    </div>
</div>

<div style="max-width: 1200px; margin: 40px auto; padding: 0 20px;">

    <div class="card" style="background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden;">
        <div style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; color: var(--text-primary);">Registered Students (<%= registrations.length %>)</h3>
            <button onclick="window.print()" class="btn" style="padding: 6px 12px; font-size: 0.9rem; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;">Print List</button>
        </div>

        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: var(--bg-body); text-align: left;">
                        <th style="padding: 12px 20px; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid var(--border-color);">Roll No</th>
                        <th style="padding: 12px 20px; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid var(--border-color);">Name</th>
                        <th style="padding: 12px 20px; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid var(--border-color);">Reg. Number</th>
                        <th style="padding: 12px 20px; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid var(--border-color);">Marks</th>
                        <th style="padding: 12px 20px; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid var(--border-color);">Status</th>
                        <th style="padding: 12px 20px; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid var(--border-color); text-align: right;">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (registrations && registrations.length > 0) { %>
                        <% registrations.forEach(reg => { %>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 12px 20px; color: var(--text-primary); font-family: monospace;"><%= reg.rollNumber %></td>
                                <td style="padding: 12px 20px; color: var(--text-primary); font-weight: 500;"><%= reg.studentName %></td>
                                <td style="padding: 12px 20px; color: var(--text-secondary); font-size: 0.9rem;"><%= reg.registrationNumber %></td>
                                <td style="padding: 12px 20px;">
                                    <% if (reg.graded) { %>
                                        <span style="font-weight: bold; color: #3fb950;"><%= reg.marks %></span>
                                    <% } else { %>
                                        <span style="color: #8b949e; font-style: italic;">-</span>
                                    <% } %>
                                </td>
                                <td style="padding: 12px 20px;">
                                    <% if (reg.submittedAt) { %>
                                        <span style="background: rgba(35, 134, 54, 0.15); color: #3fb950; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; border: 1px solid rgba(56, 139, 253, 0.1);">Submitted</span>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">
                                            <%= new Date(reg.submittedAt).toLocaleTimeString() %>
                                        </div>
                                    <% } else { %>
                                        <span style="background: rgba(248, 81, 73, 0.1); color: #f85149; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">Open / Live</span>
                                    <% } %>
                                </td>
                                <td style="padding: 12px 20px; text-align: right; display: flex; justify-content: flex-end; align-items: center; gap: 8px;">
                                    <% if (reg.submission) { %>
                                        <button onclick="viewAnswer('<%= reg._id %>', '<%= reg.marks || '' %>', <%= reg.graded %>)" class="btn" style="background: rgba(31, 111, 235, 0.1); color: #58a6ff; border: 1px solid rgba(56, 139, 253, 0.4); padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                                            <%= reg.graded ? 'Review Marks' : 'Evaluate' %>
                                        </button>
                                        <!-- Hidden Answer content for Modal -->
                                        <div id="ans-<%= reg._id %>" style="display: none;"><%= reg.submission %></div>
                                        <div id="rem-<%= reg._id %>" style="display: none;"><%= reg.remarks || '' %></div>
                                    <% } else { %>
                                        <span style="color: var(--text-secondary); font-size: 0.9rem;">-</span>
                                    <% } %>

                                    <!-- Delete Button Form -->
                                    <form action="/exams/admin/registrations/delete/<%= reg._id %>" method="POST" onsubmit="return confirm('Are you sure you want to delete this registration? This cannot be undone.');" style="margin: 0;">
                                        <button type="submit" class="btn" style="background: rgba(248, 81, 73, 0.1); color: #f85149; border: 1px solid rgba(248, 81, 73, 0.4); padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;" title="Delete Registration">
                                            üóëÔ∏è
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                No students registered for this exam yet.
                            </td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- Evaluation Modal -->
<div id="evaluationModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 1000px; width: 95%;">
        <div class="modal-header">
            <h3>Student Evaluation</h3>
            <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>
        <div class="modal-body" style="display: flex; gap: 20px; min-height: 400px; max-height: 80vh;">
            <!-- Left Side: Answer -->
            <div style="flex: 2; display: flex; flex-direction: column;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;">Student Answer</h4>
                    <button onclick="printAnswer()" class="btn" style="padding: 4px 8px; font-size: 0.8rem; border: 1px solid #ccc;">üñ®Ô∏è Print</button>
                </div>
                <div id="modalAnswerText" style="flex: 1; overflow-y: auto; background: #f6f8fa; padding: 15px; border: 1px solid #d0d7de; border-radius: 6px; font-family: 'Courier New', monospace; white-space: pre-wrap;"></div>
            </div>
            
            <!-- Right Side: Marking Form -->
            <div style="flex: 1; display: flex; flex-direction: column; border-left: 1px solid #eee; padding-left: 20px;">
                <h4 style="margin-bottom: 15px;">Grading</h4>
                <form id="evaluationForm" method="POST" action="" style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Marks</label>
                        <input type="number" name="marks" id="marksInput" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Enter marks..." required>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Remarks</label>
                        <textarea name="remarks" id="remarksInput" rows="6" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: vertical;" placeholder="Enter feedback for student..."></textarea>
                    </div>
                    <div style="margin-top: auto;">
                        <button type="submit" class="btn-primary-custom" style="width: 100%; padding: 12px; font-size: 1rem; cursor: pointer;">Save Evaluation</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 2000;
        display: flex; justify-content: center; align-items: center;
    }
    .modal-content {
        background: white; 
        border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        display: flex; flex-direction: column;
    }
    .modal-header {
        padding: 15px 20px; border-bottom: 1px solid #eee;
        display: flex; justify-content: space-between; align-items: center;
    }
    .modal-body { padding: 20px; }
    
    .btn-primary-custom {
        background: #1f6feb; color: white; border: none; border-radius: 6px;
    }
    .btn-primary-custom:hover { background: #1182fb; }

    @media (max-width: 768px) {
        .modal-body { flex-direction: column; }
        .modal-body > div { border-left: none !important; border-top: 1px solid #eee; padding-left: 0 !important; padding-top: 20px; }
    }
</style>

<script>
    function viewAnswer(regId, marks, graded) {
        const content = document.getElementById('ans-' + regId).innerText;
        const remarks = document.getElementById('rem-' + regId).innerText;
        
        document.getElementById('modalAnswerText').innerText = content;
        document.getElementById('marksInput').value = (marks && marks !== 'null') ? marks : '';
        document.getElementById('remarksInput').value = remarks;
        
        // Set form action
        document.getElementById('evaluationForm').action = '/exams/admin/registrations/mark/' + regId;
        
        document.getElementById('evaluationModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('evaluationModal').style.display = 'none';
    }

    function printAnswer() {
        const text = document.getElementById('modalAnswerText').innerText;
        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>Print Answer</title>');
        printWindow.document.write('</head><body style="font-family: monospace; white-space: pre-wrap;">');
        printWindow.document.write(text);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    }

    
    // Close on click outside
    document.getElementById('answerModal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
</script>

<%- include("../../partials/footer") %>
