<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= exam.title %> - Exam Session</title>
    <!-- Importing fonts for real paper feel -->
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #f5f5f5;
            --paper-width: 210mm; /* A4 width */
            --paper-color: #ffffff;
            --text-main: #111;
            --accent-ui: #2c3e50;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-body);
            margin: 0;
            padding: 0;
            font-family: "Inter", sans-serif;
            color: var(--text-main);
            overflow-x: hidden;
        }

        /* Top Bar UI */
        .exam-status-bar {
            background: #1a1a1a;
            color: white;
            padding: 0 20px;
            height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .student-identity {
            font-size: 0.9rem;
            opacity: 0.9;
            display: flex;
            gap: 15px;
        }
        .student-identity strong { color: #58a6ff; }

        .time-monitor {
            background: #231f20;
            border: 1px solid #444;
            padding: 5px 15px;
            border-radius: 4px;
            font-family: "Courier New", monospace;
            font-size: 1.2rem;
            font-weight: bold;
            color: #f85149; /* Red for urgency */
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .finish-btn {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        .finish-btn:hover { background: #b71c1c; }

        .answer-sheet-container {
            margin-top: 30px;
            border-top: 2px dashed #000;
            padding-top: 20px;
        }
        
        .answer-textarea {
            width: 100%;
            min-height: 400px;
            padding: 20px;
            font-family: "Crimson Text", serif;
            font-size: 1.2rem;
            line-height: 1.6;
            border: 1px solid #ccc;
            background: #fff;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
            resize: vertical;
            background-image: linear-gradient(#f1f1f1 1px, transparent 1px);
            background-size: 100% 2rem;
            margin-bottom: 20px;
        }
        .answer-textarea:focus { outline: 2px solid #2c3e50; }

        /* Paper Container */
        .paper-canvas {
            margin-top: 80px; /* Offset for fixed header */
            display: flex;
            justify-content: center;
            padding: 20px;
            min-height: 100vh;
        }

        .exam-sheet {
            background: var(--paper-color);
            width: 100%;
            max-width: var(--paper-width);
            min-height: 297mm; /* A4 height */
            padding: 25mm; /* Standard print margin */
            box-sizing: border-box;
            box-shadow: 0 0 20px rgba(0,0,0,0.1), 0 0 5px rgba(0,0,0,0.05);
            font-family: "Crimson Text", serif; /* Serif for paper read */
            font-size: 1.25rem; /* Readable text */
            line-height: 1.6;
            color: #000;
        }

        /* Paper Typography */
        .paper-header {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 2px solid #000;
            padding-bottom: 20px;
        }
        .paper-h1 {
            font-size: 2rem;
            font-weight: 700;
            text-transform: uppercase;
            margin: 0;
            line-height: 1.2;
        }
        .paper-meta {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .paper-instructions {
            margin: 20px 0;
            font-style: italic;
            font-size: 1rem;
            text-align: left;
        }

        .questions-content {
            white-space: pre-wrap; /* Preserve pasting format */
            text-align: justify;
        }

        /* Waiting Room UI */
        .waiting-room-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0d1117;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .countdown-timer {
            font-size: 6rem;
            font-weight: bold;
            font-family: "Courier New", monospace;
            color: #58a6ff;
            margin: 20px 0;
        }

        .start-btn-big {
            font-size: 1.5rem;
            padding: 15px 50px;
            background: #238636;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: none;
        }
        .start-btn-big:hover { background: #2ea043; }

        @media print {
            .exam-status-bar { display: none !important; }
            .modal-overlay { display: none !important; }
            .waiting-room-overlay { display: none !important; }
            .paper-canvas { margin: 0; padding: 0; }
            .exam-sheet { box-shadow: none; width: 100%; max-width: none; }
            body { background: white; }
        }

        /* Responsive Design Overlay */
        @media screen and (max-width: 768px) {
            :root {
                --paper-width: 100%;
            }

            .exam-status-bar {
                height: auto;
                padding: 8px; /* Reduced padding */
                flex-wrap: wrap;
                gap: 8px;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                width: 100%;
                justify-content: space-between; /* Better alignment */
                z-index: 1000;
                box-sizing: border-box; /* Ensure padding includes in width */
            }

            .student-identity {
                width: 100%;
                justify-content: space-between;
                font-size: 0.8rem;
                order: 1;
                margin-bottom: 2px;
                display: flex;
            }
            
            .student-identity div {
                 white-space: nowrap;
                 overflow: hidden;
                 text-overflow: ellipsis;
                 max-width: 48%;
            }

            /* Force the next two items to share the next row properly */
            .time-monitor {
                order: 2;
                flex: 1 1 auto; /* Grow and shrink */
                min-width: 120px; /* Minimum width for timer */
                justify-content: center;
                background: #333; 
                font-size: 1rem; /* Slightly smaller */
                padding: 4px 8px;
                margin: 0;
            }

            .finish-btn {
                order: 3;
                flex: 0 0 auto; /* Do not grow, do not shrink */
                padding: 6px 12px;
                font-size: 0.85rem;
                white-space: nowrap;
                margin: 0;
            }

            .questions-content {
                word-wrap: break-word;
                font-size: 1rem;
            }

            .questions-content img {
                max-width: 100% !important;
                height: auto !important;
            }

            .paper-canvas {
                margin-top: 130px; /* Adjusted top margin for taller header */
                padding: 10px;
            }

            .exam-sheet {
                padding: 20px;
                min-height: auto;
                width: 100%;
                max-width: 100%;
            }

            .paper-h1 {
                font-size: 1.5rem;
            }

            .paper-meta {
                flex-direction: column;
                gap: 5px;
                font-size: 0.9rem;
            }

            .answer-textarea {
                padding: 10px;
                font-size: 1rem;
                min-height: 250px;
            }

            /* Waiting Room Responsive */
            .countdown-timer {
                font-size: 3rem;
            }
            
            .start-btn-big {
                padding: 12px 30px;
                font-size: 1.2rem;
            }

            /* Modal Responsive */
            .modal-content {
                width: 95%;
                margin: 0 auto;
            }
            
            .modal-footer {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-footer button {
                width: 100%;
                margin: 0 !important;
            }
            
            .completion-message {
                padding: 20px !important;
            }

            .completion-message h1 {
                font-size: 1.5rem;
            }

            .print-only-content hr {
                margin: 20px 0 !important;
            }
            
            /* Responsive Grid for Images */
            #imagePreviewGrid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)) !important;
            }
        }
    </style>
</head>
<body oncontextmenu="return false;">

    <!-- Fixed Header for Student Info & Timer -->
    <div class="exam-status-bar">
        <div class="student-identity">
            <div>
                User: <strong><%= registration.studentName %></strong>
            </div>
            <div>
                Roll No: <strong><%= registration.rollNumber %></strong>
            </div>
        </div>
        <div class="time-monitor" id="timerDisplay">
             --:--:--
        </div>
        <button class="finish-btn" onclick="submitExam()">SUBMIT TEST</button>
    </div>

    <!-- Main Content -->
    <div class="paper-canvas">
        
        <!-- Submission Modal -->
        <div id="submitModal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Submit Examination</h3>
                    <button onclick="closeSubmitModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
                </div>
                <div class="modal-body">
                    <p>You are about to submit your exam. Please confirm your action.</p>
                    <p style="color: #666; font-size: 0.9rem;">Tip: You can print your question paper and answers before submitting.</p>
                </div>
                <div class="modal-footer">
                    <button onclick="window.print()" class="btn-secondary-custom">üñ®Ô∏è Print Paper</button>
                    <div style="flex: 1;"></div>
                    <button onclick="closeSubmitModal()" class="btn-secondary-custom" style="margin-right: 10px;">Cancel</button>
                    <button onclick="confirmSubmit()" class="btn-primary-custom" style="background: #d32f2f;">Confirm Submit</button>
                </div>
            </div>
        </div>

        <style>
             .modal-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 2000;
                display: flex; justify-content: center; align-items: center;
            }
            .modal-content {
                background: white; width: 90%; max-width: 500px;
                border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                display: flex; flex-direction: column;
            }
            .modal-header {
                padding: 15px 20px; border-bottom: 1px solid #eee;
                display: flex; justify-content: space-between; align-items: center;
            }
            .modal-body { padding: 20px; }
            .modal-footer {
                padding: 15px 20px; border-top: 1px solid #eee;
                display: flex; align-items: center;
            }
        </style>

        <% if (status === "waiting") { %>
            <div class="waiting-room-overlay" id="waitingRoom">
                <div style="text-align: center;">
                    <h1>Exam begins in</h1>
                    <div class="countdown-timer" id="countdownDisplay">00:00:00</div>
                    <p style="color: #8b949e;">Please keep this window open.</p>
                    <button class="start-btn-big" id="startExamBtn" onclick="startTest()">START EXAM</button>
                </div>
            </div>
        <% } %>

        <!-- The Physics Paper Look -->
        <div class="exam-sheet" id="examPaper" style="<%= status === "waiting" ? "display:none;" : "" %>">
            <% if (status === "ended") { %>
                <div class="completion-message" style="text-align: center; padding: 50px;">
                    <% if (registration.submittedAt) { %>
                        <h1 style="color: #238636;">Test Submitted Successfully!</h1>
                        <p>You have already completed this exam.</p>
                        <p style="color: #666; font-size: 0.9rem;">Submitted on: <%= new Date(registration.submittedAt).toLocaleString() %></p>
                    <% } else { %>
                        <h1>Examination Ended</h1>
                        <p>The exam time is over.</p>
                    <% } %>
                    
                    <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center;">
                        <a href="/exams" class="btn-primary-custom" style="text-decoration: none;">Exit to Dashboard</a>
                    </div>
                </div>

                <!-- Hidden on screen but visible on print usually, 
                     but here we want it visible below for review if they want to print it. 
                     Let's just show the paper below the message. -->
                <div class="print-only-content">
                    <hr style="margin: 40px 0;">
                    <div class="paper-header">
                        <h1 class="paper-h1"><%= exam.title %></h1>
                        <div class="paper-meta">
                            <span>Date: <%= new Date(exam.date).toLocaleDateString() %></span>
                        </div>
                    </div>
                    <div class="questions-content">
                        <%= exam.questionPaperContent %>
                    </div>
                    
                    <% if (registration) { %>
                    <div class="answer-sheet-container" style="margin-top: 50px; border-top: 2px dashed #000; padding-top: 20px;">
                        <h3>YOUR ANSWERS</h3>
                        <div style="white-space: pre-wrap; font-family: 'Crimson Text', serif; font-size: 1.2rem;"><%= registration.submission || "No text answer provided." %></div>
                        
                        <% if (registration.submissionFiles && registration.submissionFiles.length > 0) { %>
                            <div style="margin-top: 20px; border-top: 1px dotted #ccc; padding-top: 20px;">
                                <h4>Attached Images:</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                                    <% registration.submissionFiles.forEach(function(url, index) { %>
                                        <div style="border: 1px solid #ddd; padding: 5px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                            <a href="<%= url %>" target="_blank">
                                                <img src="<%= url %>" style="width: 100%; height: 150px; object-fit: cover;" alt="Answer Image <%= index + 1 %>">
                                            </a>
                                            <div style="text-align: center; font-size: 0.8rem; margin-top: 5px; color: #666;">Page <%= index + 1 %></div>
                                        </div>
                                    <% }); %>
                                </div>
                            </div>
                        <% } else if (registration.submissionFile) { %>
                            <!-- Legacy Single File -->
                             <div style="margin-top: 20px;">
                                <a href="<%= registration.submissionFile %>" target="_blank" class="btn-secondary-custom">View Attached File</a>
                            </div>
                        <% } %>
                    </div>
                    <% } %>
                </div>

                <style>
                    /* When ended, we show the paper below but maybe we want to hide certain UI elements */
                    .completion-message { display: block; }
                    
                    @media print {
                        .completion-message { display: none; }
                        .exam-status-bar { display: none; }
                        body { background: white; }
                        .paper-canvas { margin: 0; padding: 0; }
                        .exam-sheet { box-shadow: none; max-width: 100%; width: 100%; }
                    }
                    
                    /* Button Styles for this section */
                    .btn-secondary-custom {
                        padding: 10px 20px;
                        background: white;
                        border: 1px solid #ccc;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 1rem;
                    }
                    .btn-primary-custom {
                        padding: 10px 20px;
                        background: #238636;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 1rem;
                    }
                </style>
            <% } else { %>
                <div class="paper-header">
                    <h1 class="paper-h1"><%= exam.title %></h1>
                    <div class="paper-meta">
                        <span>Max Time: <%= (new Date(exam.endTime) - new Date(exam.startTime)) / 60000 %> Minutes</span>
                        <span>Date: <%= new Date(exam.date).toLocaleDateString() %></span>
                    </div>
                </div>

                <div class="paper-instructions">
                    <strong>Instructions:</strong> <%= exam.instructions %>
                </div>
                <hr style="border-top: 2px solid #000; margin-bottom: 30px;">
                
                <div class="questions-content">
                    <%= exam.questionPaperContent %>
                </div>
                 
                <div class="answer-sheet-container">
                    <h3>ANSWER SHEET</h3>
                    <p style="font-style:italic; font-size:0.9rem;">Type your answers below OR upload photos of your handwritten sheets.</p>
                    
                    <form id="examForm" action="/exams/submit" method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="regId" value="<%= registration._id %>">
                        
                        <div style="margin-bottom: 20px; padding: 20px; border: 2px dashed #ccc; border-radius: 8px; text-align: center; background: #f9f9f9;">
                            <label for="answerFiles" style="font-weight: 600; cursor: pointer; display: block; font-size: 1.1rem; color: #2c3e50;">
                                üì∏ Add Answer Photos (Select Multiple)
                                <input type="file" name="answerFiles" id="answerFiles" accept="image/*" multiple style="margin-top: 15px; display: block; margin: 10px auto;">
                            </label>
                            <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">(Supported: JPG, PNG. Max 20 images)</p>
                            
                            <!-- Image Preview Grid -->
                            <div id="imagePreviewGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 15px;"></div>
                            
                            <div id="fileList" style="margin-top: 10px; font-size: 0.9rem; color: #2ea44f; font-weight: bold;"></div>
                        </div>

                        <textarea class="answer-textarea" name="submission" placeholder="Type your answers here (optional if you are uploading images)..."></textarea>
                    </form>
                </div>
                
                <script>
                    document.getElementById('answerFiles').addEventListener('change', function(e) {
                        const files = Array.from(e.target.files);
                        const count = files.length;
                        const previewGrid = document.getElementById('imagePreviewGrid');
                        
                        document.getElementById('fileList').innerText = count > 0 ? `‚úÖ ${count} file(s) selected` : '';
                        
                        // Clear previous previews
                        previewGrid.innerHTML = '';

                        if(count > 0) {
                            files.forEach((file, index) => {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    const div = document.createElement('div');
                                    div.style.position = 'relative';
                                    div.style.border = '1px solid #ddd';
                                    div.style.borderRadius = '4px';
                                    div.style.overflow = 'hidden';
                                    
                                    div.innerHTML = `
                                        <img src="${e.target.result}" style="width: 100%; height: 80px; object-fit: cover; display: block;">
                                        <div style="font-size: 0.7rem; padding: 2px; text-align: center; background: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${file.name}</div>
                                    `;
                                    previewGrid.appendChild(div);
                                }
                                reader.readAsDataURL(file);
                            });
                        }
                    });
                </script>

                <div style="margin-top: 50px; text-align: center; font-size: 0.9rem; font-style: italic;">
                    *** END OF PAPER ***
                </div>
            <% } %>
        </div>

    </div>

    <script>
        const status = "<%= status %>";
        let timeLeft = <%= timeLeft %>; // seconds
        
        const timerDisplay = document.getElementById("timerDisplay");
        const countdownDisplay = document.getElementById("countdownDisplay");
        const startBtn = document.getElementById("startExamBtn");
        const waitingRoom = document.getElementById("waitingRoom");
        const examPaper = document.getElementById("examPaper");

        function formatTime(seconds) {
            if(seconds < 0) return "00:00:00";
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2, "0")}:${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
        }

        function updateTimer() {
            if (timeLeft > 0) {
                timeLeft--;
                const formatted = formatTime(timeLeft);
                
                if (status === "waiting") {
                    if (countdownDisplay) countdownDisplay.innerText = formatted;
                } else if (status === "live") {
                    if (timerDisplay) timerDisplay.innerText = " " + formatted;
                }
            } else {
                if (status === "waiting") {
                    if (countdownDisplay) countdownDisplay.innerText = "00:00:00";
                    if (startBtn) {
                        startBtn.style.display = "inline-block";
                        startBtn.innerText = "START EXAM";
                    }
                } else if (status === "live") {
                    if (timerDisplay) timerDisplay.innerText = "TIME UP";
                    alert("Time is Up! Submitting automatically...");
                    document.getElementById('examForm').submit();
                }
            }
        }

        setInterval(updateTimer, 1000);

        function startTest() {
            location.reload(); 
        }

        function submitExam() {
            // New Modal approach
            document.getElementById('submitModal').style.display = 'flex';
        }

        function closeSubmitModal() {
            document.getElementById('submitModal').style.display = 'none';
        }

        function confirmSubmit() {
             const btn = document.querySelector("#submitModal .btn-primary-custom");
             if(btn) {
                 btn.disabled = true;
                 btn.innerText = "Submitting... Please Wait ‚è≥";
                 btn.style.opacity = "0.7";
                 btn.style.cursor = "not-allowed";
             }
             
             // Show full screen loader
             const overlay = document.createElement('div');
             overlay.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); color:white; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:3000; font-family:sans-serif;";
             overlay.innerHTML = '<div style="font-size:3rem; margin-bottom:20px;">üì§</div><h2 style="margin:0;">Submitting Exam...</h2><p>Please do not close this window or refresh.</p>';
             document.body.appendChild(overlay);

             document.getElementById('examForm').submit();
        }
        
        // Full Screen Mode
        function openFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen().catch(err => {
                    console.log("Full screen denied");
                });
            }
        }

        // Proctoring: Detect Tab Switch
        document.addEventListener("visibilitychange", () => {
             if (document.hidden && status === "live") {
                 alert("WARNING: You switched tabs! This activity has been logged.");
                 // In a real app, send an AJAX request to increment suspicious count
             }
        });

        // Initialize display immediately
        if (status === "live") {
             timerDisplay.innerText = " " + formatTime(timeLeft);
             // Try to force full screen on first interaction
             document.body.addEventListener('click', openFullscreen, { once: true });
        }

        // Anti-Cheat (Simple)
        document.addEventListener("copy", e => e.preventDefault());
        document.addEventListener("paste", e => e.preventDefault());
    </script>
</body>
</html>
