<%- include('../partials/header') %>

<style>
    /* Bulk Page Specific Styles */
    .bulk-container {
        max-width: 1400px; /* Wider for split view */
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        padding-bottom: 50px;
    }

    @media (max-width: 1000px) {
        .bulk-container {
            grid-template-columns: 1fr;
        }
    }

    .editor-section, .preview-section {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 12px;
        padding: 25px;
        display: flex;
        flex-direction: column;
        height: 80vh;
    }

    .tab-nav {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        border-bottom: 1px solid #30363d;
        padding-bottom: 10px;
    }

    .mode-tab {
        background: transparent;
        border: none;
        color: #8b949e;
        padding: 8px 12px;
        cursor: pointer;
        font-weight: 600;
        border-radius: 6px;
        transition: all 0.2s;
    }

    .mode-tab:hover {
        background: rgba(255,255,255,0.05);
        color: #c9d1d9;
    }

    .mode-tab.active {
        background: #238636;
        color: white;
    }

    textarea.bulk-input {
        flex: 1;
        background: #0d1117;
        color: #e6edf3;
        border: 1px solid #30363d;
        border-radius: 8px;
        padding: 15px;
        font-family: 'Courier New', Courier, monospace;
        font-size: 0.9rem;
        line-height: 1.5;
        resize: none;
        outline: none;
    }

    textarea.bulk-input:focus {
        border-color: #58a6ff;
    }

    .format-guide {
        margin-top: 15px;
        background: rgba(56, 139, 253, 0.1);
        border: 1px solid rgba(56, 139, 253, 0.3);
        border-radius: 8px;
        padding: 15px;
        font-size: 0.85rem;
        color: #c9d1d9;
    }

    .format-guide code {
        background: rgba(0,0,0,0.3);
        padding: 2px 5px;
        border-radius: 4px;
        color: #58a6ff;
        font-family: monospace;
    }

    /* Preview Table */
    .preview-container {
        flex: 1;
        overflow-y: auto;
        background: #0d1117;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .preview-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }

    .preview-table th {
        background: #21262d;
        position: sticky;
        top: 0;
        z-index: 10;
        padding: 10px;
        text-align: left;
        color: #8b949e;
    }

    .preview-table td {
        padding: 10px;
        border-bottom: 1px solid #30363d;
        color: #c9d1d9;
        vertical-align: top;
    }

    .status-valid { color: #238636; font-weight: bold; }
    .status-error { color: #f85149; font-weight: bold; }

    .action-bar {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
    }

    .btn-action {
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        border: 1px solid transparent;
        transition: 0.2s;
    }

    .btn-preview { background: #30363d; color: white; border-color: var(--border-color); }
    .btn-preview:hover { background: #454c56; }

    .btn-clear { background: transparent; color: #f85149; border-color: #f85149; }
    .btn-clear:hover { background: rgba(248, 81, 73, 0.1); }

    .btn-save { background: #238636; color: white; opacity: 0.5; pointer-events: none; }
    .btn-save.active { opacity: 1; pointer-events: auto; }
    .btn-save:hover.active { background: #2ea043; }

</style>

<div style="max-width: 1400px; margin: 0 auto 20px auto; padding: 0 20px;">
    <a href="/admin/questions" style="color: #8b949e; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; margin-bottom: 10px;">
        <span>&larr;</span> Back to Question Bank
    </a>
    <h2>Bulk Add Questions</h2>
</div>

<div class="bulk-container">
    
    <!-- Left: Editor -->
    <div class="editor-section">
        <div class="tab-nav">
            <button class="mode-tab active" onclick="switchMode('simple')" id="tab-simple">Standard Mode</button>
            <button class="mode-tab" onclick="switchMode('advanced')" id="tab-advanced">Advanced / Code Mode</button>
        </div>

        <div class="action-bar">
            <strong>Input Data</strong>
            <button class="btn-action btn-clear" onclick="clearInput()">Clear</button>
        </div>
        
        <!-- Format Simple -->
        <div id="format-simple" class="input-group" style="display: flex; flex-direction: column; flex: 1;">
            <textarea id="bulkDataSimple" class="bulk-input" placeholder="Paste your simple questions here..."></textarea>
            <div class="format-guide">
                <strong>Format Guide (Standard):</strong><br>
                <code>Q: Question text</code><br>
                <code>TOPIC: Topic Name</code><br>
                <code>DIFFICULTY: easy/medium/hard</code><br>
                <code>A) Option 1</code> ... <code>ANS: A</code>
            </div>
        </div>

        <!-- Format Advanced -->
        <div id="format-advanced" class="input-group" style="display: none; flex-direction: column; flex: 1;">
            <textarea id="bulkDataAdvanced" class="bulk-input" placeholder="Paste questions with code blocks here..."></textarea>
            <div class="format-guide">
                <strong>Format Guide (Advanced/Code):</strong><br>
                <code>Q: Question text...</code><br>
                <code>int main() { ... }</code> (Multi-line code allowed)<br>
                <code>TOPIC: C++ Functions</code> (Marks end of question)<br>
                <code>DIFFICULTY: hard</code><br>
                <code>A) Option 1</code> ... <code>ANS: B</code>
            </div>
        </div>
        
        <button class="btn-action btn-preview" onclick="parseQuestions()" style="margin-top: 15px; width: 100%; padding: 12px;">
            Preview & Validate &rarr;
        </button>
    </div>

    <!-- Right: Preview -->
    <div class="preview-section">
        <div class="action-bar">
            <strong>Preview (<span id="countDisplay">0</span> valid)</strong>
            <button id="saveBtn" class="btn-action btn-save" onclick="saveQuestions()">Save All to Bank</button>
        </div>

        <div class="preview-container">
            <table class="preview-table">
                <thead>
                    <tr>
                        <th width="50%">Question</th>
                        <th>Details</th>
                        <th>Answer</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="previewBody">
                    <tr>
                        <td colspan="4" style="text-align: center; color: #8b949e; padding: 30px;">
                            Click "Preview" to validate your input.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="errorSummary" style="color: #f85149; font-size: 0.9rem; min-height: 20px;"></div>
    </div>
</div>

<script>
    let parsedQuestions = [];
    let currentMode = 'simple';

    function switchMode(mode) {
        currentMode = mode;
        document.getElementById('tab-simple').className = `mode-tab ${mode === 'simple' ? 'active' : ''}`;
        document.getElementById('tab-advanced').className = `mode-tab ${mode === 'advanced' ? 'active' : ''}`;
        
        document.getElementById('format-simple').style.display = mode === 'simple' ? 'flex' : 'none';
        document.getElementById('format-advanced').style.display = mode === 'advanced' ? 'flex' : 'none';
        
        // Auto-fill advanced example if empty
        if (mode === 'advanced' && document.getElementById('bulkDataAdvanced').value === '') {
            document.getElementById('bulkDataAdvanced').value = `Q: What is the issue in this function?

void print(int *p) {
    cout << *p;
}

TOPIC: Pointers
DIFFICULTY: medium
A) Syntax Error
B) Dereferencing uninitialized pointer
C) Nothing wrong
D) Pointer is null
ANS: B`;
        }
    }

    function clearInput() {
        if(confirm('Clear all input?')) {
            if (currentMode === 'simple') document.getElementById('bulkDataSimple').value = '';
            else document.getElementById('bulkDataAdvanced').value = '';
            
            document.getElementById('previewBody').innerHTML = '';
            parsedQuestions = [];
            updateSaveButton();
        }
    }

    function parseQuestions() {
        const inputId = currentMode === 'simple' ? 'bulkDataSimple' : 'bulkDataAdvanced';
        const text = document.getElementById(inputId).value;
        const lines = text.split('\n'); // Keep empty lines for code formatting in advanced mode
        
        let questions = [];
        let currentQ = null;

        if (currentMode === 'simple') {
            // SIMPLE PARSER (Strict Line-by-Line)
            lines.forEach(line => {
                line = line.trim();
                // if (line === '') return; // ALLOW EMPTY LINES

                if (line.match(/^Q\d*[:\.]|^Q\s/i)) { // MATCH Q1:, Q:, Q2., etc.
                    if (currentQ) validateAndPush(questions, currentQ);
                    
                    // Cleanup question prefix (Q1: .. -> ..)
                    let qText = line.replace(/^Q\d*[:\.]\s*/i, '').trim();
                    currentQ = createNewQuestion(qText);
                } else if (currentQ) {
                    parseMetadata(currentQ, line);
                }
            });
        } else {
            // ADVANCED PARSER (Multi-line Question Text Support)
            // Logic: Everything between Q: and TOPIC: is part of Question Text
            
            lines.forEach(line => {
                // Remove trailing whitespace but keep indent for code
                const trimmedLine = line.trim();

                // Check for Start of new Question
                if (trimmedLine.match(/^Q\d*[:\.]|^Q\s/i)) {
                    if (currentQ) validateAndPush(questions, currentQ);
                    let qText = trimmedLine.replace(/^Q\d*[:\.]\s*/i, '').trim();
                    currentQ = createNewQuestion(qText);
                    currentQ.parsingState = 'TEXT'; // State tracking
                } 
                else if (currentQ) {
                    // Check if we hit the limiters
                    if (trimmedLine.match(/^TOPIC[:\-]/i)) {
                        currentQ.parsingState = 'META';
                        currentQ.topic = trimmedLine.replace(/^TOPIC[:\-]\s*/i, '');
                    }
                    else if (currentQ.parsingState === 'TEXT') {
                        // Still reading question description/code
                        // Preserve empty lines if inside code, but maybe trim excessive ones?
                        // For now, just append.
                        currentQ.questionText += '\n' + line; 
                    }
                    else {
                        // Parsing Metadata (Difficulty, Options, Ans)
                        parseMetadata(currentQ, trimmedLine);
                    }
                }
            });
        }
        
        // Push last one
        if (currentQ) validateAndPush(questions, currentQ);

        parsedQuestions = questions;
        renderPreview();
    }

    function createNewQuestion(text) {
        return {
            questionText: text,
            options: [],
            topic: 'General',
            difficulty: 'medium',
            correctOption: null,
            rawAns: null,
            error: []
        };
    }

    function parseMetadata(q, line) {
        if (line.match(/^TOPIC[:\-]/i)) {
            q.topic = line.replace(/^TOPIC[:\-]\s*/i, '');
        } else if (line.match(/^DIFFICULTY[:\-]/i)) {
             q.difficulty = line.replace(/^DIFFICULTY[:\-]\s*/i, '').toLowerCase();
        } else if (line.match(/^[A-D]\)/)) {
            q.options.push(line.replace(/^[A-D]\)\s*/, ''));
        } else if (line.match(/^ANS[:\-]/i)) {
            const ansChar = line.replace(/^ANS[:\-]\s*/i, '').trim().toUpperCase();
            const map = {'A': 0, 'B': 1, 'C': 2, 'D': 3};
            if (map[ansChar] !== undefined) q.correctOption = map[ansChar];
            q.rawAns = ansChar;
        }
    }

    function validateAndPush(list, q) {
        // Clean up question text
        q.questionText = q.questionText.trim();
        
        // Validation Logic
        if (!q.questionText) q.error.push("Missing Question Text");
        if (q.options.length < 2) q.error.push("Need at least 2 options");
        if (q.correctOption === null) q.error.push("Missing or Invalid Answer (Format: ANS: A)");
        
        // Validate Difficulty Enum if strictly required by Schema
        const validDiff = ['easy', 'medium', 'hard'];
        if (!validDiff.includes(q.difficulty)) q.difficulty = 'medium'; // Fallback

        list.push(q);
    }

    function renderPreview() {
        const tbody = document.getElementById('previewBody');
        tbody.innerHTML = '';
        let validCount = 0;
        let hasErrors = false;

        parsedQuestions.forEach((q, idx) => {
            const isValid = q.error.length === 0;
            if(isValid) validCount++;
            else hasErrors = true;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div style="font-weight: 600;">${q.questionText.substring(0, 80)}${q.questionText.length>80?'...':''}</div>
                    ${q.options.map((opt, i) => `<div style="color: #8b949e; font-size: 0.8rem;">${String.fromCharCode(65+i)}) ${opt}</div>`).join('')}
                </td>
                <td>
                    <div style="font-size: 0.8rem;">${q.topic}</div>
                    <span style="font-size: 0.75rem; background: #21262d; padding: 2px 6px; border-radius: 4px;">${q.difficulty}</span>
                </td>
                <td>
                    <strong style="color: #58a6ff;">${q.rawAns || '?'}</strong>
                </td>
                <td>
                    ${isValid 
                        ? '<span class="status-valid">Valid</span>' 
                        : `<span class="status-error">${q.error.join(', ')}</span>`
                    }
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('countDisplay').innerText = validCount;
        
        const summary = document.getElementById('errorSummary');
        if (hasErrors) {
            summary.innerText = "Please fix errors before saving.";
        } else if (parsedQuestions.length === 0) {
            summary.innerText = "";
        } else {
            summary.innerText = "All good! Ready to upload.";
        }

        updateSaveButton(validCount > 0 && !hasErrors);
    }

    function updateSaveButton(enable = false) {
        const btn = document.getElementById('saveBtn');
        if (enable) btn.classList.add('active');
        else btn.classList.remove('active');
    }

    async function saveQuestions() {
        if (!document.getElementById('saveBtn').classList.contains('active')) return;

        const btn = document.getElementById('saveBtn');
        btn.innerText = "Saving...";
        
        try {
            const response = await fetch('/admin/questions/bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ questions: parsedQuestions })
            });
            
            const result = await response.json();
            if (result.success) {
                alert(`Successfully added ${result.count} questions!`);
                window.location.href = '/admin/questions';
            } else {
                alert('Error: ' + result.message);
                btn.innerText = "Save All to Bank";
            }
        } catch (e) {
            console.error(e);
            alert('Network Error');
            btn.innerText = "Save All to Bank";
        }
    }
    
    // Auto-fill example on load if empty
    window.onload = function() {
        if(document.getElementById('bulkDataSimple').value === '') {
            document.getElementById('bulkDataSimple').value = `Q: What follows the Green Revolution?
TOPIC: Agriculture
DIFFICULTY: hard
A) White Revolution
B) Blue Revolution
C) Yellow Revolution
D) Golden Revolution
ANS: D

Q: Value of pi?
TOPIC: Mathematics
DIFFICULTY: easy
A) 3.14
B) 2.14
C) 4.14
D) 1.14
ANS: A`;
        }
    }
</script>

<%- include('../partials/footer') %>
