<%- include('../partials/header') %>

<!-- TEST DATA PAYLOAD -->
<div id="testDataPayload" style="display:none;"><%= testData %></div>




<style>
    :root {
        --bg-passage: #0d1117;
        --bg-questions: #161b22;
        --border-color: #30363d;
        --accent-color: #58a6ff;
        --text-primary: #e6edf3;
        --text-secondary: #8b949e;
        --font-passage: 'Georgia', 'Times New Roman', serif;
        --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", 'Inter', Helvetica, Arial, sans-serif;
    }

    /* FULLSCREEN LAYOUT ENGINE */
    html, body {
        height: 100vh;
        width: 100vw;
        margin: 0;
        padding: 0;
        overflow: hidden; /* Prevent global scroll */
        background: var(--bg-questions);
        display: flex;
        flex-direction: column;
    }

    /* Override any global container styles */
    .container, .main-content-wrapper {
        max-width: none !important;
        margin: 0 !important;
        padding: 0 !important;
        width: 100%;
        flex: 1; /* Grow to fill space below navbar */
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* Navbar Fixes */
    nav.navbar {
        flex-shrink: 0;
        z-index: 50;
        border-bottom: 1px solid var(--border-color);
        width: 100%;
    }

    /* APP CONTAINER */
    .reading-app {
        flex: 1;
        display: flex;
        flex-direction: column;
        width: 100%;
        overflow: hidden;
        position: relative;
    }

    /* MAIN SPLIT VIEW */
    .split-view {
        flex: 1;
        display: flex;
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    /* ----- LEFT PANEL: PASSAGE (42%) ----- */
    .panel-passage {
        width: 42%;
        background-color: var(--bg-passage);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        position: relative;
        transition: width 0.3s ease;
    }

    .panel-passage.focus-mode {
        width: 100% !important;
        position: absolute;
        z-index: 200;
        height: 100%;
    }

    .passage-header {
        height: 56px;
        padding: 0 20px;
        background: rgba(13, 17, 23, 0.95);
        backdrop-filter: blur(8px);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        z-index: 10;
        position: sticky;
        top: 0;
    }

    .passage-title {
        font-family: var(--font-ui);
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--accent-color);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .passage-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .control-btn {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        border-radius: 4px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-family: var(--font-ui);
        font-weight: 600;
        font-size: 0.9rem;
    }
    .control-btn:hover {
        background: #21262d;
        color: var(--text-primary);
        border-color: var(--text-secondary);
    }

    .passage-content {
        flex: 1;
        overflow-y: auto;
        padding: 40px;
        color: var(--text-primary);
        font-family: var(--font-passage);
        line-height: 1.8;
        font-size: 1.125rem; /* 18px default */
        scroll-behavior: smooth;
    }
    
    .passage-content h2 {
        font-family: var(--font-ui);
        font-size: 1.5rem;
        margin-top: 0;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .passage-content p {
        margin-bottom: 1.5em;
    }


    /* ----- RIGHT PANEL: QUESTIONS (58%) ----- */
    .panel-questions {
        width: 58%;
        background-color: var(--bg-questions);
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .questions-header {
        height: 56px;
        padding: 0 24px;
        background: rgba(22, 27, 34, 0.95);
        backdrop-filter: blur(8px);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        z-index: 10;
    }

    .section-title {
        font-family: var(--font-ui);
        font-weight: 600;
        font-size: 1rem;
        color: var(--text-primary);
    }

    .progress-badge {
        font-family: var(--font-ui);
        background: #21262d;
        color: var(--text-secondary);
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
        border: 1px solid var(--border-color);
    }

    .questions-scroll-area {
        flex: 1;
        overflow-y: auto;
        padding: 30px;
        scroll-behavior: smooth;
    }

    /* CARD DESIGN */
    .question-card {
        background: #0d1117;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 24px;
        position: relative;
    }

    .question-card::before {
        content: '';
        position: absolute;
        left: 0;
        top: 24px;
        bottom: 24px;
        width: 3px;
        background: transparent;
        border-radius: 0 4px 4px 0;
        transition: background 0.2s;
    }
    .question-card.answered::before {
        background: #238636;
    }

    .q-text {
        font-family: var(--font-ui);
        font-weight: 600;
        font-size: 1.05rem;
        margin-bottom: 20px;
        display: block;
        color: var(--text-primary);
        line-height: 1.5;
    }

    .q-options-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
    }

    .option-item {
        display: flex;
        align-items: flex-start;
        padding: 12px 16px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        background: #161b22;
    }

    .option-item:hover {
        background: #1f242c;
        border-color: var(--text-secondary);
    }

    .option-item.selected {
        background: rgba(56, 139, 253, 0.1);
        border-color: var(--accent-color);
        box-shadow: 0 0 0 1px var(--accent-color);
    }

    .opt-key {
        font-family: var(--font-ui);
        font-weight: 700;
        font-size: 0.85rem;
        color: var(--text-secondary);
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 14px;
        flex-shrink: 0;
        transition: all 0.2s;
        margin-top: -2px; /* Visual align */
    }

    .option-item.selected .opt-key {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }

    .opt-content {
        font-family: var(--font-ui);
        color: var(--text-secondary);
        font-size: 0.95rem;
        line-height: 1.5;
    }
    .option-item.selected .opt-content {
        color: var(--text-primary);
        font-weight: 500;
    }

    /* FOOTER NAV BAR */
    .nav-footer {
        height: 72px;
        background: #161b22;
        border-top: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 32px;
        flex-shrink: 0;
        z-index: 50;
    }

    .nav-btn {
        height: 40px;
        padding: 0 20px;
        border-radius: 6px;
        font-family: var(--font-ui);
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
    }

    .btn-prev {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
    }
    .btn-prev:hover:not(:disabled) {
        border-color: var(--text-primary);
        color: var(--text-primary);
    }
    .btn-prev:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-next {
        background: var(--accent-color);
        border: none;
        color: white;
        box-shadow: 0 2px 8px rgba(88, 166, 255, 0.3);
    }
    .btn-next:hover {
        background: #79c0ff;
    }
    
    .btn-submit {
        background: #238636;
        border: none;
        color: white;
        box-shadow: 0 2px 8px rgba(46, 160, 67, 0.4);
    }
    .btn-submit:hover {
        background: #2ea043;
    }

    /* MOBILE SEGMENTED CONTROL */
    .mobile-nav-tabs {
        display: none;
        padding: 8px 16px;
        background: #161b22;
        border-bottom: 1px solid var(--border-color);
        width: 100%;
        box-sizing: border-box; /* Fix overflow */
    }
    
    .segmented-control {
        display: flex;
        background: #0d1117;
        padding: 4px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
    }

    .segment-btn {
        flex: 1;
        padding: 6px;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        font-weight: 600;
        font-size: 0.9rem;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .segment-btn.active {
        background: #21262d;
        color: var(--text-primary);
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    /* RESPONSIVE BREAKPOINTS */
    @media (max-width: 900px) {
        .split-view {
            flex-direction: column;
        }

        .panel-passage, .panel-questions {
            width: 100%;
            display: none; /* JS Toggles this */
        }
        
        .panel-passage.active, .panel-questions.active {
            display: flex;
            flex: 1;
        }

        .mobile-nav-tabs {
            display: block;
        }

        .passage-content {
            padding: 24px 20px;
            font-size: 1.05rem;
        }

        .questions-scroll-area {
            padding: 20px;
        }

        .nav-footer {
            height: 64px;
            padding: 0 16px;
        }
    }
</style>



<div class="reading-app">
    
    <!-- Mobile Tabs -->
    <div class="mobile-nav-tabs">
        <div class="segmented-control">
            <button class="segment-btn active" onclick="switchTab('passage')">Passage</button>
            <button class="segment-btn" onclick="switchTab('questions')">Questions</button>
        </div>
    </div>

    <div class="split-view">
        
        <!-- LEFT: PASSAGE -->
        <div class="panel-passage active" id="panelPassage">
            <div class="passage-header">
                <div class="passage-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 0h5.293A1 1 0 0 1 10 .293L13.707 4a1 1 0 0 1 .293.707V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2zm5.5 1.5v2a1 1 0 0 0 1 1h2l-3-3z"/></svg>
                    Reading Passage
                </div>
                <div class="passage-controls">
                    <button class="control-btn" onclick="changeFontSize(-1)" title="Decrease Size">A-</button>
                    <button class="control-btn" onclick="changeFontSize(1)" title="Increase Size">A+</button>
                    <button class="control-btn" onclick="toggleFocusMode()" title="Focus Mode">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/></svg>
                    </button>
                </div>
            </div>
            <div class="passage-content" id="passageContent">
                <!-- Content -->
            </div>
        </div>

        <!-- RIGHT: QUESTIONS -->
        <div class="panel-questions" id="panelQuestions">
            <div class="questions-header">
                <span class="section-title">Questions</span>
                <span class="progress-badge" id="progressIndicator">...</span>
            </div>
            <div class="questions-scroll-area" id="questionsContainer">
                <!-- Questions -->
            </div>
        </div>

    </div>

    <!-- FOOTER NAV -->
    <div class="nav-footer">
        <button class="nav-btn btn-prev" id="btnPrev" onclick="navigate(-1)">Previous</button>
        
        <!-- Center Action -->
        <div id="btnNextWrapper" style="display:flex; gap:10px;">
            <button class="nav-btn btn-next" id="btnNext" onclick="navigate(1)">
                Next Passage
            </button>
            <button class="nav-btn btn-submit" id="btnSubmit" onclick="submitTest()" style="display:none;">
                Submit Test
            </button>
        </div>
    </div>
</div>

<script>
    // --- LOAD DATA ---
    const rawData = document.getElementById('testDataPayload').innerText;
    const passages = JSON.parse(decodeURIComponent(rawData));
    
    // --- STATE ---
    let currentIndex = 0;
    let fontSize = 18;
    const userAnswers = {}; // { passageId: [optIdx, optIdx, ...] }

    // Init Logic
    passages.forEach(p => {
        userAnswers[p._id] = new Array(p.questions.length).fill(-1);
    });

    // --- RENDER ENGINE ---
    function render() {
        const p = passages[currentIndex];

        // 1. Passage
        const contentHtml = p.content.replace(/\r\n/g, '\n').split('\n')
            .filter(line => line.trim().length > 0)
            .map(line => `<p>${line}</p>`)
            .join('');
            
        document.getElementById('passageContent').innerHTML = `
            <h2>${p.title}</h2>
            <div>${contentHtml}</div>
        `;
        document.getElementById('passageContent').scrollTop = 0; // Reset scroll

        // 2. Questions
        const qContainer = document.getElementById('questionsContainer');
        qContainer.innerHTML = '';
        
        p.questions.forEach((q, qIdx) => {
            const card = document.createElement('div');
            card.className = 'question-card' + (userAnswers[p._id][qIdx] !== -1 ? ' answered' : '');
            
            let optsHtml = '';
            q.options.forEach((optText, optIdx) => {
                const isSelected = userAnswers[p._id][qIdx] === optIdx;
                const key = ['A','B','C','D'][optIdx];
                
                optsHtml += `
                    <div class="option-item ${isSelected ? 'selected' : ''}" 
                         onclick="selectOption('${p._id}', ${qIdx}, ${optIdx}, this)">
                        <span class="opt-key">${key}</span>
                        <span class="opt-content">${optText}</span>
                    </div>
                `;
            });

            card.innerHTML = `
                <span class="q-text">${qIdx + 1}. ${q.questionText}</span>
                <div class="q-options-grid">${optsHtml}</div>
            `;
            qContainer.appendChild(card);
        });
        qContainer.scrollTop = 0;

        // 3. Status & Nav
        document.getElementById('progressIndicator').innerText = `Passage ${currentIndex + 1} of ${passages.length}`;
        
        const btnPrev = document.getElementById('btnPrev');
        btnPrev.disabled = (currentIndex === 0);
        
        const btnNext = document.getElementById('btnNext');
        const btnSubmit = document.getElementById('btnSubmit');
        
        if (currentIndex === passages.length - 1) {
            btnNext.style.display = 'none';
            btnSubmit.style.display = 'flex';
        } else {
            btnNext.style.display = 'flex';
            btnSubmit.style.display = 'none';
        }
    }

    // --- ACTIONS ---
    function selectOption(pid, qIdx, optIdx, el) {
        // Save State
        userAnswers[pid][qIdx] = optIdx;

        // Visual Update
        const grid = el.parentElement;
        Array.from(grid.children).forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');

        // Mark Card
        grid.parentElement.parentElement.classList.add('answered');
    }

    function navigate(dir) {
        currentIndex += dir;
        render();
        
        // Auto-switch to passage on mobile when moving to new passage
        if (window.innerWidth <= 900 && dir !== 0) {
            switchTab('passage');
        }
    }

    function switchTab(mode) {
        // Toggle Buttons
        document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
        if (mode === 'passage') document.querySelector('.segment-btn:nth-child(1)').classList.add('active');
        else document.querySelector('.segment-btn:nth-child(2)').classList.add('active');

        // Toggle Panels
        document.getElementById('panelPassage').classList.toggle('active', mode === 'passage');
        document.getElementById('panelQuestions').classList.toggle('active', mode === 'questions');
        
        // Hide/Show logic for pure css toggling
        const pPanel = document.getElementById('panelPassage');
        const qPanel = document.getElementById('panelQuestions');
        
        if (mode === 'passage') {
            pPanel.style.display = 'flex';
            qPanel.style.display = 'none';
        } else {
            pPanel.style.display = 'none';
            qPanel.style.display = 'flex';
        }
    }

    function changeFontSize(d) {
        fontSize = Math.max(14, Math.min(26, fontSize + d));
        document.getElementById('passageContent').style.fontSize = fontSize + 'px';
    }

    function toggleFocusMode() {
        document.getElementById('panelPassage').classList.toggle('focus-mode');
    }

    async function submitTest() {
        // Check completion
        let total = 0, ans = 0;
        Object.values(userAnswers).forEach(arr => {
            total += arr.length;
            ans += arr.filter(v => v !== -1).length;
        });

        const msg = (ans < total) 
            ? `You have answered ${ans}/${total} questions. Submit anyway?`
            : "Ready to submit your test?";
            
        if (!confirm(msg)) return;

        try {
            const res = await fetch('/reading/student/submit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(userAnswers)
            });
            const d = await res.json();
            if (d.success) window.location.href = d.redirectUrl;
            else alert(d.message);
        } catch (e) {
            console.error(e);
            alert("Error submitting test.");
        }
    }

    // Init
    render();
    
    // Resize Listener to reset display styles removed by mobile toggle
    window.addEventListener('resize', () => {
        if (window.innerWidth > 900) {
            document.getElementById('panelPassage').style.display = 'flex';
            document.getElementById('panelQuestions').style.display = 'flex';
        } else {
            // Restore tab state
            const isPassage = document.querySelector('.segment-btn:nth-child(1)').classList.contains('active');
            switchTab(isPassage ? 'passage' : 'questions');
        }
    });

</script>

<!-- Empty footer hook just in case -->
<div style="display:none">
<%- include('../partials/footer') %>
</div>
